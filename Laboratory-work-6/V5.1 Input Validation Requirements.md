# V5.1 Контроль вхідних даних

Правильно реалізовані заходи контролю вхідних даних, з використанням «білих» списків дозволів та суворої типізації даних, можуть усунути більше 90% атак із використанням ін'єкцій. Контроль розміру та діапазону значень можуть значно зменшити ці проблеми. Вбудовування контролю вхідних даних необхідне етапах проектування архітектури докладання, розробки, і навіть модульного та інтеграційного тестування. Хоча багатьох із цих вимог немає в тестах на проникнення, результати їх невиконання зазвичай призводять до необхідності виконання вимог розділу V5.3 Кодування вихідної інформації та запобігання ін'єкціям. Розробникам і дослідникам безпеки додатків рекомендується ставитись до цього розділу так, якби для всіх пунктів був потрібен перший рівень (L1), щоб запобігти ін'єкції.

| № | Опис | L1 | L2 | L3 | CWE |
| ----- | -------------------------------------------------- -------------------------------------------------- -------------------------------------------------- -------------------------------------------------- -------------------------------------------------- -------------------------------------------------- -------------------------------------------------- --- | --- | --- | --- | --- |
| 5.1.1 | Переконайтеся, що в застосунку застосовуються механізми захисту від атак забруднення параметрів HTTP, особливо якщо платформа програми не розрізняє джерело параметрів запиту (GET, POST, файли cookie, http-заголовки або змінні середовища). | \+ | \+ | \+ | 235 |
| 5.1.2 | Переконайтеся, що фреймворки захищають від атак з масовим присвоєнням параметрів, або що програма забезпечує заходи захисту від небезпечного призначення параметрів, наприклад, позначаючи поля як private тощо. (C5) | \+ | \+ | \+ | 915 |
| 5.1.3 | Переконайтеся, що всі вхідні дані проходять форматно-логічний контроль за «білим» списком дозволених типів даних, значень атрибутів, параметрів, заголовків, запитів, методів тощо, включаючи поля HTML-форми, REST-запити, параметри URL, HTTP -заголовки, атрибути cookie, пакетні файли, RSS-канали та ін. (C5) | \+ | \+ | \+ | 20 |
| 5.1.4 | Переконайтеся, що структуровані дані строго типізовані та перевіряються за заданою схемою, в якій вказані дозволені символи, максимальна довжина та шаблон даних (наприклад, номери банківських карток, телефонів, адреси email. Перевіряється, що пов'язані поля відповідають один одному, наприклад, місту однозначно відповідає його поштовий індекс). (C5) | \+ | \+ | \+ | 20 |
| 5.1.5 | Переконайтеся, що перенаправлення URL-адреси дозволено лише за адресами зі списку дозволених. При перенаправленні на потенційно недовірену адресу відображається попередження. | \+ | \+ | \+ | 601 |




## C5: Перевірка всіх вхідних даних


### Прикмети:\_\_\_\_\_\_\_\_\_\_

Перевірка введення - це метод програмування, який гарантує, що тільки правильно відформатовані дані можуть потрапити компонент програмної системи.


#### Синтаксис і семантична валідність

Додаток повинен перевірити, що дані_є синтаксично_ і _семантично_ допустимими (у зазначеному порядку), перш ніж використовувати їх будь-яким чином (включаючи відображення їх назад користувачеві).

**Синтаксична валідність** означає, що дані знаходяться в очікуваній формі. Наприклад, програма може дозволити користувачеві вибрати чотиризначний «ідентифікатор облікового запису» для виконання будь-якої операції. Додаток повинен припускати, що користувач вводить корисні дані SQL-ін'єкції, і повинен перевірити, що дані, введені користувачем, мають рівну чотири цифри і складаються тільки з чисел (на додаток до використання правильної параметризації запиту).

**Семантична валідність** включає тільки прийом вхідних даних, які знаходяться в прийнятному діапазоні для даної функціональності і контексту програми. Наприклад, при виборі діапазонів дат дата початку повинна передувати даті закінчення.

#### Список дозволів проти заборон

Існує два загальні підходи до виконання перевірки синтаксису введення, зазвичай відомих як списки дозволів та заборон:

- **Denylisting** або **denylist validation** намагається перевірити, що дані не містять «відомо поганого вмісту. Наприклад, веб-програма може блокувати введення, що містить точний текст, щоб запобігти XSS. Однак цей захист можна було обійти за допомогою тега script в нижньому регістрі або тега script змішаного регістру
Наприклад, правило перевірки списку дозволів для штату США буде 2-літерним кодом, який є лише одним з допустимих штатів США.

**Важливо** При створенні безпечного програмного забезпечення рекомендується мінімальний підхід до списку дозволів. Заперечення схильна до помилок і може бути обійдено за допомогою різних методів ухилення і може бути небезпечним, коли залежить від нього саме по собі. Незважаючи на те, що відмову від перерахування часто можна уникнути, вона часто може бути корисною для виявлення очевидних атак. Таким чином, в той час як список дозволів допомагає обмежити поверхню атаки, гарантуючи, що дані мають правильну синтаксичну та семантичну достовірність, список заборонених дій допомагає виявити і потенційно зупинити очевидні атаки.

#### Перевірка на стороні клієнта та на стороні сервера

Перевірка введення завжди повинна виконуватися на стороні сервера для забезпечення безпеки. Хоча перевірка на стороні клієнта може бути корисною як для функціональних, так і для деяких цілей безпеки, її часто можна легко обійти. Це робить перевірку на стороні сервера ще фундаментальнішою для безпеки. Наприклад, перевірка JavaScript може попередити користувача про те, що певне поле має складатися з чисел, але серверний додаток повинен перевірити, що представлені дані складаються лише з чисел у відповідному числовому діапазоні цієї функції.

#### Регулярні вирази

Регулярні вирази пропонують спосіб перевірки відповідності даних певному шаблону. Почнемо із базового прикладу.

Наступний регулярний вираз використовується для визначення правила списку дозволів для перевірки імен користувачів.

		^\[a-z0-9\_]{3,16}$

Цей регулярний вираз допускає лише малі літери, цифри та символ підкреслення. Ім'я користувача також обмежене довжиною 3 та 16 символів.

#### Увага: Можливість відмови в обслуговуванні

Слід виявляти обережність при створенні регулярних виразів. Погано спроектовані вирази можуть призвести до потенційної відмови в обслуговуванні (він же [ReDoS] (https://www.owasp.org/index.php/Regular_expression_Denial_of_Service_-_ReDoS)). Різні інструменти можуть тестуватися, щоб переконатися, що регулярні вирази не вразливі для ReDoS.

#### Увага: Складність

Регулярні вирази є лише одним із способів виконання перевірки. Регулярні висловлювання можуть бути складними для підтримки або розуміння для деяких розробників. Інші альтернативи перевірки включають програмне написання методів перевірки, які можуть бути простіше підтримувати для деяких розробників.


#### Межі перевірки вхідних даних

**Перевірка введення не завжди робить дані «безпечними», оскільки деякі форми складного введення можуть бути «дійсними», але все ж таки небезпечними. Наприклад, дійсна адреса електронної пошти може містити атаку шляхом впровадження коду SQL, а дійсна URL-адреса - атака з використанням міжсайтових сценаріїв**. Додаткові засоби захисту, окрім перевірки введення, завжди повинні застосовуватись до даних, таких як параметризація запиту або екранування.


#### Проблеми, пов'язані з перевіркою серіалізованих даних

Деякі форми введення настільки складні, що перевірка може лише мінімально захистити програму. Наприклад, небезпечно десеріалізувати ненадійні або дані, якими може маніпулювати зловмисник. Єдиний безпечний архітектурний шаблон полягає в тому, щоб не приймати серіалізовані об'єкти з ненадійних джерел або десеріалізувати обмежені можливості тільки для простих типів даних. Слід уникати обробки серіалізованих форматів даних та по можливості використовувати більш прості для захисту формати, такі як JSON.

Якщо це неможливо, розгляньте серію захисту перевірки під час обробки серіалізованих даних.

- Реалізуйте перевірку цілісності або шифрування серіалізованих об'єктів, щоб запобігти створенню ворожих об'єктів або підробці даних.
- застосування суворих обмежень типів під час десеріалізації перед створенням об'єкта; Зазвичай код чекає набір класів. Було продемонстровано обходи цієї техніки.
- Ізолюйте код, який десеріалізується, щоб він виконувався в середовищах з дуже низькими привілеями, такими як тимчасові контейнери.
- Реєструйте винятки та збої десеріалізації безпеки, наприклад, коли вхідний тип не є очікуваним типом або десеріалізація викликає винятки.
- Обмеження або моніторинг вхідних та вихідних мережевих підключень із контейнерів або серверів, які десеріалізують.
- Слідкуйте за десеріалізацією, попереджаючи, якщо користувач десеріалізує постійно.


#### Несподіване введення даних користувачем (масове призначення)

Деякі платформи підтримують автоматичну прив'язку параметрів HTTP-запитів до серверних об'єктів, що використовується програмою. Ця функція автоматичної прив'язки дозволяє зловмиснику оновлювати об'єкти на стороні сервера, які не були призначені для зміни. Зловмисник може змінити свій рівень контролю доступу або обійти передбачувану бізнес-логіку програми за допомогою цієї функції.

Ця атака має низку назв, у тому числі: масове присвоєння, автов'язування та впровадження об'єктів.

Як простий приклад, якщо об'єкт користувача має привілей поля, який визначає рівень привілеїв користувача в додатку, зловмисник може шукати сторінки, на яких змінюються дані користувача, і додавати privilege=admin до параметрів HTTP, що відправляються. Якщо автоматична прив'язка увімкнена небезпечним чином, серверний об'єкт, що представляє користувача, буде змінено відповідним чином.

Для вирішення цієї проблеми можна використати два підходи:

- Уникайте прямої прив'язки введення та використовуйте натомість об'єкти передачі даних (DTO).
- Увімкніть автоматичну прив'язку, але налаштуйте правила списку дозволів для кожної сторінки або компонента, щоб визначити, які поля можуть бути автоматично прив'язані.

Додаткові приклади доступні в [шпаргалці OWASP Mass Assignment.](https://www.owasp.org/index.php/Mass_Assignment_Cheat_Sheet)


#### Перевірка та очищення HTML

Розглянемо програму, яка повинна приймати HTML від користувачів (через редактор WYSIWYG, який містить вміст у вигляді HTML, або функції, які безпосередньо приймають HTML у вхідних даних). У цій ситуації перевірка чи втеча не допоможуть.

- Регулярні вирази недостатньо виразні, щоб зрозуміти складність HTML5.
- Кодування або екранування HTML не допоможе, оскільки це призведе до неправильного відображення HTML.

Тому вам потрібна бібліотека, яка може аналізувати та очищати текст у форматі HTML. Будь ласка, ознайомтесь зі [шпаргалкою XSS Prevention з очищення HTML для отримання](https://www.owasp.org/index.php/XSS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet#RULE_.236_-_Sanitize_HTML_Markup_with_a


#### Функціональність перевірки у бібліотеках та платформах

Усі мови та більшість фреймворків надають бібліотеки або функції перевірки, які слід використовувати для перевірки даних. Бібліотеки перевірки зазвичай охоплюють загальні типи даних, вимоги до довжини, цілі діапазони, перевірки "is null" і багато іншого. Багато бібліотек і платформ перевірки дозволяють визначити власний регулярний вираз або логіку для перевірки користувача таким чином, щоб програміст міг використовувати цю функціональність у всьому додатку. Приклади функцій перевірки включають [функції фільтра](https://secure.php.net/manual/en/filter.examples.validation.php) PHP або [Hibernate Validator](http://hibernate.org/validator/) для Java. Приклади дезінфікуючих засобів HTML включають [метод очищення Ruby on Rails](http://edgeapi.rubyonrails.org/classes/ActionView/Helpers/SanitizeHelper.html),[OWASP Java HTML Sanitizer](https://www.owasp.org /index.php/OWASP_Java_HTML_Sanitizer_Project) або [DOMPurify](https://github.com/cure53/DOMPurify).

## CWE-235: Неправильна обробка додаткових параметрів

### Прикмети:\_\_\_\_\_\_\_\_\_\_\_

Програма не обробляє або неправильно обробляє, коли кількість параметрів, полів або аргументів з однаковим ім'ям перевищує очікувану суму.

### Застосовні платформи

Мови

Клас: Не залежить від мови (невизначена поширеність)

### Загальні наслідки

| Розмах | Удар | Можливість |
| ----------- | ---------------------------------------------- | ----------- |
| Цілісність | Технічний вплив: несподіваний стан |

## CWE-915: Неправильно керована модифікація динамічно визначених атрибутів об'єкта

## Прикмети:\_\_\_\_\_\_\_\_\_\_

Програмне забезпечення отримує вхідні дані від вищого компонента, який задає кілька атрибутів , властивостей або полів, які повинні бути ініціалізовані або оновлені в об'єкті, але він неправильно контролює які атрибути можуть бути змінені.

### Розширений опис

Якщо об'єкт містить атрибути, які призначені лише для внутрішнього використання, їх несподівана модифікація може призвести до вразливості.

Ця слабкість іноді відома за специфічними для мови механізмами, які роблять це можливим, таким як масове присвоєння, автов'язування або впровадження об'єктів.

### Застосовні платформи

#### Мови

Ruby (невизначена поширеність)

ASP.NET (невизначена поширеність)

PHP (невизначена поширеність)

Python (невизначена поширеність)

Клас: Не залежить від мови (невизначена поширеність)

### Загальні наслідки

| Сфера | Вплив | Імовірність |
| -------------- | -------------------------------------------------- -------------------------------------------------- - | ---------- |
| Цілісність | Технічний вплив: зміна даних програми. Зловмисник може змінити конфіденційні дані або програмні змінні. | |
| Цілісність | Технічний вплив: виконання несанкціонованого коду чи команд | |
| Інші | Технічний вплив: відхилення залежно від контексту; Змінити логіку виконання | |

## CWE-20: Неправильна перевірка введених даних

### Опис

Продукт отримує вхідні дані або дані, але він не перевіряє або неправильно перевіряє, що вхідні дані мають властивості, необхідні для безпечної та правильної обробки даних.

### Розширений опис 
Перевірка вхідних даних — це часто використовувана техніка для перевірки потенційно небезпечних вхідних даних, щоб переконатися, що вхідні дані безпечні для обробки в коді або під час обміну даними з іншими компонентами. Якщо програмне забезпечення не перевіряє введені дані належним чином, зловмисник можливий для створення вводу у форматі, який не застосовується до останнього застосування. Це буде спрямовано на частини системи для запобігання ненавмисному введенню, яке може бути введено в контрольований контроль, довільне керування ресурсом або довільне виконання коду.

Input validation не є тільки технологією для процесування введення, але. Інші технології, спрямовані на перетворення потенційно-небезпечного введення в деякий спосіб, такий як filtering ([CWE-790](https://cwe.mitre.org/data/definitions/790.html)) - які домагаються remove dangerous inputs - or encoding/escaping ([CWE-116](https://cwe.mitre.org/data/definitions/116.html)), які вірять, що натискати, що не вмикається, коли він включений у вихід до іншого компонента . Інші технології exist as well (see[CWE-138](https://cwe.mitre.org/data/definitions/138.html) for more examples.)

Вхідна перевірка може бути застосована до:

- необроблені дані - рядки, цифри , параметри, вміст файлів і т.д.
- metadata - інформація про те, щоб вирощувати дані, так як заголовки або розмір

Data може бути простим або структурованим. Структуровані дані можуть бути складені багатьма невтішними літерами, складені комбінаціями metadata і нерівними даними, з іншими простими або структурованими даними.

Багато властивостей необроблених даних або метаданих необхідно перевірити під час введення в код, наприклад:

- вказані величини, такі як розмір, довжина, частота, ціна, швидкість, кількість операцій, час тощо.
- спричинені або видалені розміри, такі як поточний розмір файлу встановлюється на певний розмір
- індекси, зміщення або позиції в більш складних структурах даних
- символічні ключі або інші елементи в хеш-таблицях, асоціативних масивах і т.д.
- добре сформованість, тобто синтаксична коректність - відповідність очікуваному синтаксису
- Лексична правильність лексичного маркера - відповідність правилам того, що розглядається як токен
- заданий або похідний тип - фактичний тип входу (або те, яким здається вхід)
- узгодженість - між окремими елементами даних, між необробленими даними і метаданими, між посиланнями і т.д.
- сприйняття домашніх конкретних правил, наприклад бізнес-логіка
- еквівалентність - засвідчуючи, що подібні вхідні дії, як правило, залежать від самих - автентичності
- аттестацій про вхід, наприклад, криптографічний підпис до виводу з джерела даних

Зверніть увагу, що "перевірка введення" має дуже різні засоби до різних людей, або зрізними класифікаціями схем. Необхідно дотримуватися обережності при посиланні на це введення CWE або зіставлення з ним. Для прикладу, деякі векселі можуть беззастережно вести керування керуванням до атаки над дзвінком, якщо вони не повинні бути здатні до повідомленого дзвінка на всіх, але деякі з них є пов'язаними з тим, як validation.

Наприкінці, це важливо для сприяння тому, що відмінності між введенням validation і output escape є розмитим, a developers повинні бути надійними, щоб запобігти difference, включно з тим, як введення validation не є в повному обсязі потрібні типи, що потребують, підтримуються, наприклад, текст вільної форми. Розглянемо сценарій SQL-ін'єкції, в якому прізвище людини вставляється в запит. Назва "O'Reilly" повинна бути добре пройти крок перевірки, оскільки це поширене прізвище англійською мовою. Незважаючи на це, це дійсне ім'я може не бути безпосередньо внесено в 데이터베이스, тому що міститься в "'" apostrophe character, який повинен бути необхідний, щоб бути втечею або іншіперетворені. У цьому випадку, відхиляючи агресивний глибокий погіршення ризику SQL-ін'єкції, але це може бути неправильна поведінка, оскільки було б записано неправильне ім'я.

### Застосовні платформи

#### Мови
Клас: Не мова-Specific_(часто поширена)

### Загальні наслідки

| **_Область_** | **_Вплив_** | **_Ймовірність_** |
| ---------------------------------------------- | -------------------------------------------------- -------------------------------------------------- -------------------------------------------------- -------------------------------------------------- -------------------------------------------------- ------- | ---------------- |
| _Доступність_ | **_Технічний вплив:_**_ DoS: збій, вихід або перезапуск; DoS: споживання ресурсів (ЦП); DoS: споживання ресурсів (пам’яті)__зловмисник може проявити невиявлені значення і спричинити програмне скасування або надмірне споживання ресурсів, таких як пам’ять і процесор._ | |
| _Конфіденційність_ | **_Технічний вплив:_**_ читання пам’яті; Завантажувальні файли або Каталоги__Зловмисник може використовувати конкретні дані, якщо вони можуть бути доступні для управління ресурсами сторінок._ | |
| _Чісність__Конфіденційність__Доступність_ | **_Технічний вплив:_**_ Зміна пам’яті; Виконайте неавторизований код або команди__Зловмисник може використати зловмисний вхід для зміни даних або можливої зміни потоку керування неочікуваними способами, включаючи довільне виконання команд._ | |

### Імовірність прояву

Висока

## CWE-601: Перенаправлення URL-адрес на ненадійний сайт («відкрите перенаправлення»)

### Ознаки:\_\_\_\_\_\_\_

Веб-програма приймає керований користувачем вхід, який визначає посилання на зовнішній сайт, і використовує це посилання для перенаправлення. Это упрощает фишинговые атаки.

### Расширенний опис

Параметр http може містити значення URL-адреси і може вказувати на те, що веб-прикладення перенаправляє запит на вказаний URL-адресу. Змінивши значення URL-адреси на шкідливий сайт, зловмисник може успішно запустити фішингове мошенництво та прикрасити облікові дані користувача. Оскільки ім'я сервера в зміненому файлі ідентично вихідному сайту, спроби фішингу мають більш надійний зовнішній вигляд.

### Застосовні платформи

#### Мови

Клас: Не залежить від мови_(невизначена поширеність)_

### Загальні наслідки


|  Масштаб |  Втрата |  Ймовірність |
| ---------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------- |
| _Управління доступом_ | **_Технічне вплив:_**_ Механізм захисту від обходу; Отримання привілеїв або прийняття посвідчення__Користувач може бути перенаправлено на ненадежну сторінку, що містить корисне ПО, яке потім може скомпрометувати комп’ютер користувача. Це пов’язано з широким ризиком користувача, і взаємодія користувача з веб-сервером також може бути скомпрометована, якщо шкідливе ПО здійснить кейлоггування або інші атаки, які закінчаться вчиненими даними, особистою інформацією (PII) або іншими важливими даними._ | |
| _Контроль доступу_ _Конфіденційність_ _Другое_ | **_Технічне вплив:_**_ Механізм захисту від обходу; Отримати привілегії або прийняти посвідчення особистості; Другое\_\_\_\_\_\_\_\_\_\_ Користувач може підвергнутися фішинговим атакам, будучи перенаправленим на недовірену сторінку. Фішингова атака може навести на контрольовану зловмисником веб-сторінку, яка є довіреним веб-узлом. Потім фішери можуть прикрашати учетні дані користувача, а потім використовувати ці учетні дані для доступу до законного веб-сайту._ | |

### Імовірність прояву

_Низький_






